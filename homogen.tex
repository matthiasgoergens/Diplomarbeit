\documentclass[a4paper]{amsart} % ams-article nehmen.
\usepackage{a4}
\usepackage{charter}
\usepackage[english]{babel}
\usepackage[utf8]{inputenc}
\usepackage{amssymb}
\usepackage{amsfonts}
\usepackage{units}
\usepackage{amsmath}

\usepackage{a4}

\author{Matthias Görgens}

% ---- LATIN ----
\def\etal{\emph{et~al.}}
\def\ie{\emph{i.e.}}
\def\eg{\emph{e.g.}}
\def\vitae{vit\ae{}}
\def\apriori{\emph{a~priori}}
\def\aposteriori{\emph{a~posteriori}}

% ---- FRENCH ----
\def\naive{na\"{\i}ve}
\def\Naive{Na\"{\i}ve}
\def\naively{na\"{\i}vely}	% Okay, I know, this isn't French.
\def\Naively{Na\"{\i}vely}


% Other
\def\Cpp{C\raisebox{0.5ex}{\tiny\bf++}}


\newcommand{\ol}[1]{\overline{#1}}
%\newcommand{\todo}[1]{\marginpar{#1}}
\newcommand{\todo}[1]{\footnote{#1}}

\DeclareMathOperator{\In}{in}
\DeclareMathOperator{\Out}{out}

%für ein/aus-gehende kanten
\newcommand{\ina}{\ensuremath{\vec{\In}}}
\newcommand{\outa}{\ensuremath{\vec{\Out}}}

%für knoten ein/aus-gehender kanten.
\newcommand{\inv}{\ensuremath{\dot{\In}}}
\newcommand{\outv}{\ensuremath{\dot{\Out}}}

\usepackage{hyperref}
\begin{document}

\title{Homogeneous vehicle schedules}

\begin{abstract}
  Although most railroad timetables remain in use for half a
  year, they tend to repeat themself each week.  Thus one can also
  repeat their implementations in rolling stock, the vehicle
  schedulings, each week.

  But timetables show even more structure: All the working days of the
  week are usually identical.  This work sets out to investigate how
  to preserve this similarity in vehicle schedulings.  We define
  homogeneous vehicle schedulings, establish a measure of partial
  homogenity and search for ways to efficiently find the most
  homogeneous vehicle scheduling for a given timetable.
\end{abstract}

\maketitle
\todo{unterschied zwischen fahrplan und umlaufplan im abstract ausarbeiten.}

\todo{Eigene konsistente Definitionen für Zug, Nutzfahrt etc:\\
Nutzfahrt = Train\\
Zug = set of trains, set}

\section{Introduction}
Unlike individual traffic in cars, railroads in Germany are run by
only a few companies and of those Deutsche Bahn controls a huge
majority.  In principle the planning required can be centralized for
coordination.  Thus one can exploit effects of synergy.  Even
relatively modest relative improvements can have a huge absolute
impact.  So it is worthwhile to solve the encountered problems to
optimality.

One large block---or even the largest--- of opportunities for
mathematical planning in this contexts lies in the area of scheduling.
Currently at Deutsche Bahn the system for planning schedules is
multi-tiered.  This paper has been written while working at department
GSU1 of Deutsche Bahn Mobility Logistics.  The focus at GSU1 is on
improving the process of (strategic) vehicle schedulings.

As a passenger one only interfaces with the timetables, that specify
when and where a train will arrive and depart.  One does not care too
much which specific physicial train one is using or what it does
before and after the trip.

\todo{Ein abregenzendes Wort zu timetable und operationeller Plannung
  im Vergleich.}

Naturally the railroad company does not create and annihilate trains
for every trip.  It has to re"use them.  Various costs have to be
taken into account.  Introducing our first bit of notation we call
trips offered to the customer \textit{service
  trips}\todo{Nutzfahrt=service trip} and other trips will be called
\textit{empty trips}\todo{Leerfahrten}.  Empty trips may be necessary
because one station may have more service trips starting than
arriving.  Or it could keep the balance in theory, but only with long
unproductive standing times.

The most important objective concerns the minimisation of the number
of trains needed to honour all required service trips in the
timetable.  Avoiding empty trips ranks second, because they cost
man-hours, fuel, and bring the next obligatory maintenance--- whose
intervalls are based on distance travelled---closer.

Deutsche Bahn has only recently brought sophisticated math to bear on
these problems.  There are legacy heuristics in place that solved (and
do solve) scheduling, but with no guarantees of optimality.  Also
customs and preferences have developed.

For example planners\todo{Wer genauer?} prefer their schedule to be as
homogene as possible.  In former times each day has been planned in
isolation first and only then have those plans been merged.  With
identical timetables\todo{Zusammenhang genauer erklaeren.} for each
working day of the week\todo{Zur Wiederholung im Wochenabstand muss
  frueher etwas gesagt werden.} one got identical vehicle schedulings
for those days that were only slightly tweaked at the beginning and
end of the working week to fit with the sparser timetable of the
weekend.

The new methods based on mixed integer programming consider the whole
week right from the start.  Apart from the partly repeating schedule
they have no cause to use similar vehicle schedulings on the working
days.  But planners have come to price the homogenity.\todo{Why?}
\section{Thanks}
Thanks to Hanno Sch"ulldorf, Volker Kaibel and Andreas Huck for their help.

\section{Some definitions}

Let \(G=(V,A)\) be a digraph of connected stations, \eg{} ordinary
railway stations, maintenance shops.  Now look at \label{trains}
\textit{trains} \((v, t_v, w, t_w) \in \left(V \times \mathbb{R}\right)^2 \)
where \(v\), \(t_v\) name the station and time of departure, and
\(w\), \(t_v\) name the station and time of arrival.  We call a set of
trains \(T \subseteq \left(V \times \mathbb{R}\right)^2\) a timetable.  (In
practise \(T\) can also be a multiset.)

We want to focus our attention to cyclic timetables.  A timetable \(T\)
is \label{cyclic} \textit{cyclic}, iff there exists a period \(w \in
\mathbb{R}^+\), so that for each train \((v, t_v, w, t_w) \in T\)
the trains \(\{(v, t_v+n w, w, t_w +n w) \mid n \in \mathbb{Z}\}\)
are also in \(T\).  We will identify cyclic timetables with their
image under the canonic morphism
\(\varphi \colon \left(V \times \mathbb{R}\right)^2
\to \left(V \times \mathbb{R}/{\left(w \mathbb{Z}\right)}\right)^2\).

A timetable only fixes the services offered by the railroad company.
But it does not specify where the locomotives and waggons in use come
from or where they go afterwards.  Naturally one wants to re-use
rolling stock from one train for another one.  So one seeks to
establish a digraph \(G_S=(T,S\subseteq T^2)\), where each train has
exactly one predecessor and exactly one successor.  Thus \(G_s\)
consists of cycles.

\todo{motivation.  warum keine einfacheren ansätze?}

In practise timetables repeat every week \ie{} \(w = 7 \textrm{ days}\).
This work will deal with timetables that show more structure: Fix an
interval \(d := \frac{w}{n}\) with \(n \in \mathbb{N}^+\) (\eg for
days in a week, let \(n=7\)).  We partition the trains into
equivalence classes that share the same arrival and departure
stations, and whose arrival and departure times only differ by an
integral multiply of \(w\) (\ie{} whole days):
\begin{equation}
  \left[\left( v, t_v, w, t_w \right) \right]_d := \{(v, t_v+n d, w, t_w +n d) \mid n \in \mathbb{Z}\}
\end{equation}
Let \(C\) be the set of all those classes.

Ideally each class has exactly one member for each day of the week.
That would allow \(w = 1 \textrm{ day}\) instead of \(w = 7 \textrm{ days}\)
and enable a schedule that repeats perfectly every day.  But more
typical me observe a lot of classes in a timetable with one member
each day from Monday to Friday and none on the weekends.  Or even less
regular arrangements.

We will define a distance function \(\Delta_S (s,t)\) on paths in
\(S\) as the sum of arc lengths \(d\) in the path between the
trains \(s\) and \(t\) or \(\infty\) if no such path exists.  We can
talk about \emph{the} path \(P \subseteq S\) between \(s\) and \(t\),
because \(G_S\) consists only of disjoint cycles.
\[\Delta_{S}\colon T \times T \to \mathbb{R}^+_0 \cup \{\infty\}\]
\begin{equation}
\label{defDelta}
\Delta_S (s,t) = \begin{cases}
\sum_{(v,w)\in P} d(v,w) & \textrm{if there is a path \( P \in S\) between \(s\) and \(t\)}\\
\infty & \textrm{else}
\end{cases}
\end{equation}

\todo{Bezeichnungen!  Pfeile über t?}

\todo{Mehrwöchige Fahrten!  Zurückgehen auf die ursprüngliche nicht-zyklische Version!}

Of course we have only moved the problem.  We still have to define the length of a single arc:  \(d(t, \ol{t})\) shall be the minimal time that a vehicle needs to provide \(t\) and be ready for the departure of \(\ol{t}\):
\[
d ((\cdot, t_{\textrm{dep}}, \cdot, t_{\textrm{arr}}), (\cdot, \ol{t_{\textrm{dep}}},\cdot, \cdot)  :=
\min (\{\ol{t_{\textrm{dep}}} - t_{\textrm{dep}} + n w \mid \ol{t_{\textrm{dep}}} - t_{\textrm{arr}} + nw \geq 0, n \in \mathbb{Z}\} \cap \mathbb{R}^+_0)
\]

In most cases this will be just the difference \(\ol{t_{\textrm{dep}}}
- t_{\textrm{dep}}\), but we may need to add a whole number of weeks
if \(\ol{t}\) departs before \{t\} arrives.  Also a more general approach
has to be taken when trains take more than one week from arrival to
departure.

To guarantee homogenity one might \naively{} propose that all members
of one class \(c_1\) only be succeeded by members of the same class
\(c_2\).  But that would not be practial, because \eg a class that is
offered all week would be banned from being connected to a class of trains that
are not offered on the weekend.

\todo{motivation.  faellt aus der luft.. zitat der begriffsbestimmung.}
So we introduce a weaker condition.  A schedule \(S\) is called
homogenous iff:
\begin{itemize}
\item Given classes \(z, \ol{z} \in C\)
\item and trains \(r_1, r_2 \in z\) and \(\ol{r}_1,\ol{r}_2 \in \ol{z}\)
\item with \( d (r_1, r_2) = d(\ol{r}_1, \ol{r}_2) \),
\item then either there is no path between neither \(r_1\) and
  \(\ol{r}_2\) nor \(r_2\) and \(\ol{r}_2\) in \(S\); or they are connected by paths of the same length:
\begin{equation}
\label{homoEq}
  \Delta_S (r_1, \ol{r_1}) = \Delta_S (r_2, \ol{r_2})\textrm{.}
\end{equation}
\end{itemize}


\todo{motivation fuer definition}
For arcs in a digraph \(G=(V,A)\) we will use the following notation:
\begin{align*}
\ina\colon  V &\to \mathcal{P}(A) \\
v &\mapsto \left(V \times \{v\}\right) \cap A\\
%\end{align*}
2%\begin{align*}
\outa\colon  V &\to \mathcal{P}(A) \\
v &\mapsto \left(\{v\} \times V\right) \cap A\\
%\end{align*}
%\begin{align*}
\inv\colon  V &\to \mathcal{P}(V) \\
v &\mapsto \left\{ u \colon \left(u,v\right) \in \ina(v) \right\}\\
%\end{align*}
%\begin{align*}
\outv\colon  V &\to \mathcal{P}(V) \\
v &\mapsto \left\{w \colon \left(v,w\right) \in \outa\left(v\right) \right\}\\
\end{align*}

\section{An infinite integer linear program}

Let \(T\) be a timetable.  And let \(G_\mathbb{S} := (T, \mathbb{S} =
T \times T) \) be its associated complete graph.  A schedule \(G_S = (T, S \subseteq \mathbb{S})\)
will be a subgraph of \(G_\mathbb{S}\).


For the integer program we introduce the variable \(m\) with the following domain and interpretation:
\todo{Notation: \(\cong\) means ``defined as'' or ``interprete as''}
\begin{align}
  m & \colon T \times T \to \{0,1\} \\
  m & \cong \mathbf{1}_{\mathbb{S}}
\end{align}

% subto matching_aus:
%       forall <v> in V:
%       	     sum <w> in V: umlauf[v,w] == 1;
% subto matching_ein:
%       forall <w> in V:
%       	     sum <v> in V: umlauf[v,w] == 1;

The following two equations capture the requirement that \(G_S\) consists of cycles.  For all \(r \in T\):
\begin{align}
  \label{matchBedingung}
  \sum_{a \in \ina(r)}  m(a) = \sum_{a \in \outa(r)} m(a) = 1
\end{align}

To reflect the values of \(\Delta_S\) in the integer program we use the binary variables \(\delta\):
\begin{align}
  \delta \colon T \times T \times \mathbb{R} & \to \{0,1\} \\
  \delta\left(r, q, \Delta_S\left(r,q\right)\right) &\cong 1 \\
  \label{onlyOne}
  \sum_{z \in \mathbb{R}} \delta(r, q, z) &\leq 1
\end{align}

For every path \(P \subseteq \mathbb{S}\) that starts in \(r\) and ends in \(q\) we have:
\begin{align}
\label{zwingHoch}
\sum_{a \in P} (m(a) - 1) \leq \delta \left(r,q, \sum_{a \in P} d \left(a\right)\right) - 1 \textrm{;}
\end{align}
\ie{} if \(P \subseteq S\) then length of \(P\) gives
the distance between its endpoints in \(S\).

And for every \(r\)-\(q\)-cut \(C \subseteq T\) (with \(r \in C\)):
\begin{align}
\label{zwingRunter}
  \sum_{a \in C \times (T \setminus C)} m(a) \geq \sum_{z \in R} \delta (r,q, z)
\end{align}

% \(G_S=(T,S\subseteq T^2)\)


% Aufbau: Modell oder Anwendung?
% Anwendung: Umlaufplanung etc, Abschätzung anderer Möglichkeiten.  Anwendung zur Motivation.
% Welcher Umfang zur Anwendung?  Literatur.  Allgemeine Beschreibung?  Irgendeine Referenz wird es schon geben.

% relation durch Übersetzung von Nutzfahrt ersetzen.

\todo{welche constraints?  labels und refs.  convex set vs gitterpunkte?}
Those constraints define a convex set.  Alas we can't use them
directly, since there are an infinite number of constraints.  But
fortunately they are constructed for use with row generation.  We will
show that there is a finite subset of constraints that define the same
polytope.  And we will show how to define a polynomial oracle to find
violated constraints.

\todo{Fuege die eigentliche homogenitaetsbedingung hinzu!}

\section{Finitizing the integer linear program}

Equation \ref{matchBedingung} holds for all \(r \in T\) and \(T\) is
already finite.  We declared \(\Delta_S\) to map into \(R^+_0 \cup
\{\infty\}\), but we can restrict the image even further:
\todo{notation: \(\oplus\) is the Minkowski sum.}
\begin{equation}
\label{einfacher}
\Delta_S (s,t) \in \{d (s,t)\} \oplus w \mathbb{N}_0
\end{equation}
\todo{Proof why \ref{einfacher} holds!}

Thus all \(\delta (s, t, z)\) with \(z \notin \{d (s,t)\} \oplus w
\mathbb{Z}\) vanish.  Furthermore because of the way \(\Delta_S\) is
defined in \ref{defDelta} we can bound it from above and below. Call
\[M := \sum_{(r,q) \in T \times T} d (r,q)\]
and note
\[0 \leq \Delta_S(s,t) \leq M \textrm{.}\]


Now for every \(s,t \in T\) the equations in an infinite number of
variables described by \ref{onlyOne} can be replaced by the finite:
\begin{align}
  \label{onlyOneFinite}
  \mathop{\sum_{z \in \left\{d (s,t)\right\} \oplus w \mathbb{N}_0}}_{z\leq M} \delta(r, q, z) & \leq 1 \\
  \label{zwingRunterFinite}
  \sum_{a \in C \times (T \setminus C)} m(a) & \geq \mathop{\sum_{z \in \left\{d (s,t)\right\} \oplus w \mathbb{N}_0}}_{z\leq M} \delta (r,q, z) \\
\end{align}

To simplify our notation we will introduce \(L := \{0, 1, \dots,
\left\lceil \frac{M}{w} \right\rceil \}\) and substitue \(D\) for
\(\delta\):
\begin{align}
  D \colon & T \times T \times L  \to \{0,1\} \\
          & (s,       t,        n)                              \mapsto \delta (s,t, d(s,t) + n w)
%  D (s,t,n) := 
\end{align}
Now we can rewrite \ref{onlyOneFinite} and \ref{zwingRunterFinite}:
\begin{align}
  \label{onlyOneFiniteN}
  \sum_{n \in L} D (r, q, n) & \leq 1 \\
  \label{zwingRunterFiniteN}
  \sum_{a \in C \times (T \setminus C)} m(a) & \geq \sum_{n \in L} D (r,q, n)
\end{align}

Putting \ref{zwingHoch} into the new form poses bigger
problem. \todo{hier erklaerung einfuegen.}  For every path \(P
\subseteq \mathbb{S}\) that starts in \(r\) and ends in \(q\) we have:
\begin{align}
%\sum_{a \in P} (m(a) - 1) \leq \delta \left(r,q, \sum_{a \in P} d \left(a\right)\right) - 1  \\
%\sum_{a \in P} (m(a) - 1) \leq D \left(r,q, \left[ \sum_{a \in P} d \left(a\right) \right] \right) - 1 \\
\sum_{a \in P} (m(a) - 1) \leq D \left(r,q, \frac{\left(\sum_{a \in P} d \left(a\right)\right) -d(r,q)}{w}\right) - 1  \\
\label{zwingHochFiniteN}
\sum_{a \in P} (m(a) - 1) \leq D \left(r,q, \sum_{a \in P} \frac{ d \left(a\right)}{w} - \frac{d(r,q)}{w}\right) - 1
\end{align}

\todo{Vorher koennten wir n fuer jeden Bogen unabhaeging waehlen.  Jetzt
  muessen wir eine Abhaengigkeit fordern.  Gluecklicherweise koennen wir das statisch
  bestimmen!

  Was ist die Laenge von \(P\) in terms of n in abhaengigkeit der
  zwischenschritte?  Und das hat auch geklappt in \ref{zwingHochFiniteN}}

\todo{Formuliere das verendlichte Problem konkret.  Und fuege die eigentliche homogenitaetsbedingung hinzu!}

\section{Row (and Column) Generation}
Even the finitized problem suffers from an exuberant size.
\todo{Abschaetzung der Groesse angeben.  O(Pfade + Cuts).}  But we can
start solving with only the equations \ref{matchBedingung} that
guarantee a flow free of sources and sinks and the variables \(m\).
All other variables are treated as parameters set to zero.

We analyse the solutions obtained.  The variables \(m\) specify a
graph made of cycles.  For every cycle we can get the distance
\(\Delta\) between all of its nodes by straight-forward counting in
time \(O(T^2)\) \todo{Details zum Zaehlen.} (or employing Bellman-Ford
etc).  All distances between nodes in different cycles are \(\infty\)
by definition \ref{defDelta}.  \todo{Perhaps use lazy evaluation to enumerate
  all flaws.  Pick the first.}

First check \ref{onlyOne} for every pair of vertices.  If a pair, say
\(s,t\), violates \ref{onlyOne}, let \[B := \left\{z\leq M \mid
  \delta(r,q,z) = 1\right\} \cap {\left\{d (s,t)\right\} \oplus w
  \mathbb{N}_0}\] and add
\begin{equation}
  \sum_{z \in B} \delta(r, q, z)  \leq 1
\end{equation}
to the problem.
  

If \ref{onlyOne} holds, \(D\) implies a \(\ol{\Delta_S}\).  Calculate
\(\Delta_S\).  Fix a pair of vertices \(v,w\).  If \(\ol{\Delta_S
  (v,w)} = \Delta_S(v,w)\), do nothing.  Otherwise:
\begin{itemize}
  \item If \(\Delta_S < \infty\), then let \(P\) be the path between \(v\) and \(w\) in \(S\) and add the row
   \begin{equation}
    \sum_{a \in P} (m(a) - 1) \leq D \left(r,q, \sum_{a \in P} \frac{ d \left(a\right)}{w} - \frac{d(r,q)}{w}\right) - 1 \textrm{.}
    \end{equation} 
 \item If \(\Delta_S = \infty\), then let \(C \subseteq S\) be the cycle that includes \(v\) and add:
    \begin{equation}
      \sum_{a \in C \times (T \setminus C)} m(a) \geq \sum_{n \in L} D (r,q, n)
    \end{equation}
    to the problem.
\end{itemize}

\todo{Describe algorithm to find/produce a violated row.  Analyse its
  runtime.  Data structures?}

\todo{Row generation and elimination!  Or more specifically:
  Replacement by stricter constraints.  (Ignore until later.  Just add
  rows as needed.  Cplex will also take care of variables.)}

At the beginning there will be variables that are not present in any
constraint.  A solver like \textsc{Cplex} will only add them to the
problem as the constraints make them have an impact \ie as they show
up with at least one non-zero coefficient in at least one constraint
or the objective function.


\section{Balancing homogenity with other objectives?}
Homogenity is a very soft objective and its value is hard to measure
in money.  The effort invested in achieving it, is intended to enhance
adoption of the other optimizing work done at department GSU1.

\section{Implementation?}

Implementation will be done in the Cplex-framework existing at
department GSU1 of Deutsche Bahn Mobility Logistics AG.
\section{Conclusion}

\end{document}
